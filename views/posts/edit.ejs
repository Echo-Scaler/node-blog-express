<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Story — Byte &amp; Beyond</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --bg: #f7f6f3;
        --surface: #ffffff;
        --surface2: #f2f1ee;
        --border: #e3e2de;
        --border2: #ccc9c2;
        --text: #1c1b19;
        --text-2: #5a5854;
        --text-3: #9a9793;
        --accent: #2563eb;
        --accent-dk: #1d4ed8;
        --danger: #dc2626;
        --success: #16a34a;
        --warn: #d97706;
        --radius: 10px;
        --radius-lg: 14px;
        --shadow: 0 2px 8px rgba(0, 0, 0, 0.07), 0 0 0 1px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.1);
        --font-body: "DM Sans", sans-serif;
        --font-serif: "Lora", Georgia, serif;
      }

      body {
        background: var(--bg);
        font-family: var(--font-body);
        color: var(--text);
        min-height: 100vh;
      }

      /* ── HEADER ── */
      .editor-header {
        position: sticky;
        top: 0;
        z-index: 200;
        height: 56px;
        background: rgba(247, 246, 243, 0.92);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .back-btn {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: var(--surface);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        text-decoration: none;
        color: var(--text-2);
        transition:
          background 0.15s,
          color 0.15s;
      }
      .back-btn:hover {
        background: var(--border);
        color: var(--text);
      }
      .site-name {
        font-family: var(--font-serif);
        font-size: 17px;
        font-weight: 700;
        letter-spacing: -0.01em;
        background: linear-gradient(135deg, #6366f1, #10b981);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      /* FIX: was referencing a non-existent #save-status element */
      .save-status {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-3);
        background: var(--surface2);
        padding: 3px 10px;
        border-radius: 20px;
        transition:
          color 0.2s,
          background 0.2s;
      }
      .save-status.saving {
        color: var(--warn);
        background: #fef3c7;
      }
      .save-status.saved {
        color: var(--success);
        background: #dcfce7;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #2563eb);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        overflow: hidden;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .btn {
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 600;
        padding: 8px 18px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: all 0.15s;
      }
      .btn-ghost {
        background: transparent;
        color: var(--text-2);
      }
      .btn-ghost:hover {
        background: var(--surface2);
        color: var(--text);
      }
      .btn-primary {
        background: var(--text);
        color: #fff;
      }
      .btn-primary:hover {
        background: #333;
      }
      .btn-primary:disabled {
        background: var(--border2);
        color: var(--text-3);
        cursor: not-allowed;
      }

      .save-mode-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        color: #d97706;
        margin-left: 8px;
      }

      /* ── LAYOUT ── */
      .editor-shell {
        display: grid;
        grid-template-columns: 1fr 320px;
        max-width: 1200px;
        margin: 0 auto;
        min-height: calc(100vh - 56px);
      }

      /* ── EDITOR MAIN ── */
      .editor-main {
        padding: 40px 48px 80px;
        border-right: 1px solid var(--border);
      }

      /* Cover */
      .cover-zone {
        position: relative;
        width: 100%;
        height: 240px;
        border-radius: var(--radius-lg);
        border: 2px dashed var(--border2);
        background: var(--surface2);
        overflow: hidden;
        cursor: pointer;
        transition:
          border-color 0.2s,
          background 0.2s;
        margin-bottom: 32px;
      }
      .cover-zone:hover {
        border-color: var(--accent);
        background: #eef3fd;
      }
      .cover-zone.has-image {
        border-style: solid;
        border-color: transparent;
      }
      .cover-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 10px;
        pointer-events: none; /* FIX: prevents double-fire */
      }
      .cover-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
      }
      .cover-label span {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-2);
      }
      .cover-label small {
        font-size: 11px;
        color: var(--text-3);
      }
      #image-preview {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
      }
      .cover-change-btn {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        padding: 5px 12px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        display: none;
        backdrop-filter: blur(6px);
        pointer-events: all;
      }
      .cover-zone.has-image .cover-change-btn {
        display: block;
      }
      .cover-zone.has-image .cover-label {
        display: none;
      }
      #cover-file {
        display: none;
      }

      /* Fields */
      .field-wrap {
        position: relative;
        margin-bottom: 6px;
      }
      .field-error {
        font-size: 11px;
        font-weight: 500;
        color: var(--danger);
        margin-top: 4px;
        display: none;
      }
      .field-error.show {
        display: block;
      }

      .title-input {
        width: 100%;
        font-family: var(--font-serif);
        font-size: 36px;
        font-weight: 700;
        line-height: 1.2;
        color: var(--text);
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        padding: 0;
        display: block;
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
        overflow: hidden;
      }
      .title-input::placeholder {
        color: #d0cfc9;
      }
      .title-input:focus {
        border-bottom-color: var(--accent);
      }
      .title-input.error {
        border-bottom-color: var(--danger);
      }

      .char-count {
        font-size: 11px;
        color: var(--text-3);
        text-align: right;
        margin-top: 4px;
      }
      .char-count.warn {
        color: var(--warn);
      }
      .char-count.over {
        color: var(--danger);
        font-weight: 600;
      }

      .subtitle-input {
        width: 100%;
        font-family: var(--font-serif);
        font-size: 20px;
        font-style: italic;
        color: var(--text-2);
        line-height: 1.5;
        border: none;
        background: transparent;
        outline: none;
        resize: none;
        padding: 0;
        display: block;
        margin-top: 16px;
        border-bottom: 2px solid transparent;
        transition: border-color 0.2s;
        overflow: hidden;
      }
      .subtitle-input::placeholder {
        color: #d0cfc9;
      }
      .subtitle-input:focus {
        border-bottom-color: var(--border2);
      }
      .editor-divider {
        border: none;
        border-top: 1px solid var(--border);
        margin: 28px 0;
      }

      /* Toolbar */
      .rte-toolbar {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 2px;
        background: var(--surface);
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius) var(--radius) 0 0;
        padding: 6px 8px;
      }
      .tb-group {
        display: flex;
        align-items: center;
        gap: 2px;
      }
      .tb-sep {
        width: 1px;
        height: 22px;
        background: var(--border);
        margin: 0 6px;
      }
      .tb-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: var(--text-2);
        cursor: pointer;
        font-size: 13px;
        font-weight: 700;
        font-family: var(--font-body);
        transition:
          background 0.12s,
          color 0.12s;
        position: relative;
      }
      .tb-btn:hover {
        background: var(--surface2);
        color: var(--text);
      }
      .tb-btn.active {
        background: var(--text);
        color: #fff;
      }
      .tb-btn[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--text);
        color: #fff;
        font-size: 11px;
        font-weight: 500;
        padding: 3px 8px;
        border-radius: 5px;
        white-space: nowrap;
        pointer-events: none;
        letter-spacing: 0.01em;
        z-index: 10;
      }
      .tb-select {
        font-family: var(--font-body);
        font-size: 12px;
        font-weight: 500;
        color: var(--text-2);
        background: transparent;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 6px;
        appearance: none;
      }
      .tb-select:hover {
        background: var(--surface2);
      }

      /* RTE body */
      .rte-body {
        border: 1px solid var(--border);
        border-radius: 0 0 var(--radius) var(--radius);
        background: var(--surface);
        min-height: 440px;
        max-height: 600px;
        overflow-y: auto;
        padding: 24px 28px;
        outline: none;
        font-family: var(--font-serif);
        font-size: 18px;
        line-height: 1.85;
        color: var(--text);
        caret-color: var(--accent);
      }
      .rte-body:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
      }
      .rte-body.error {
        border-color: var(--danger);
      }
      .rte-body:empty::before {
        content: attr(data-placeholder);
        color: #ccc9c2;
        pointer-events: none;
      }
      .rte-body h1 {
        font-size: 28px;
        font-weight: 700;
        margin: 24px 0 12px;
      }
      .rte-body h2 {
        font-size: 22px;
        font-weight: 700;
        margin: 20px 0 10px;
      }
      .rte-body h3 {
        font-size: 18px;
        font-weight: 700;
        margin: 16px 0 8px;
      }
      .rte-body p {
        margin: 0 0 16px;
      }
      .rte-body blockquote {
        border-left: 4px solid var(--accent);
        margin: 20px 0;
        padding: 12px 20px;
        background: #f0f4ff;
        border-radius: 0 8px 8px 0;
        font-style: italic;
        color: var(--text-2);
      }
      .rte-body ul,
      .rte-body ol {
        padding-left: 28px;
        margin: 0 0 16px;
      }
      .rte-body li {
        margin-bottom: 6px;
      }
      .rte-body a {
        color: var(--accent);
        text-decoration: underline;
      }
      .rte-body code {
        font-family: "Courier New", monospace;
        font-size: 14px;
        background: var(--surface2);
        border: 1px solid var(--border);
        padding: 1px 6px;
        border-radius: 4px;
      }
      .rte-body pre {
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 16px 20px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 16px 0;
      }
      .rte-body pre code {
        background: none;
        border: none;
        padding: 0;
        font-size: 13px;
        color: inherit;
      }
      .rte-body img {
        max-width: 100%;
        border-radius: 8px;
        margin: 8px 0;
      }
      .rte-body hr {
        border: none;
        border-top: 2px solid var(--border);
        margin: 32px 0;
      }

      .rte-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 14px;
        background: var(--surface2);
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 var(--radius) var(--radius);
        font-size: 11px;
        color: var(--text-3);
      }

      /* Stats */
      .stats-row {
        display: flex;
        gap: 16px;
        margin-top: 20px;
      }
      .stat-item {
        text-align: center;
      }
      .stat-num {
        font-size: 18px;
        font-weight: 700;
        color: var(--text);
      }
      .stat-label {
        font-size: 10px;
        color: var(--text-3);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 500;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal-box {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 28px 32px;
        width: 420px;
        max-width: 92vw;
        box-shadow: var(--shadow-md);
        animation: slideUp 0.2s ease;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .modal-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .modal-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }
      .modal-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-2);
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .modal-input {
        font-family: var(--font-body);
        font-size: 14px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px 12px;
        outline: none;
        color: var(--text);
        transition: border-color 0.15s;
        width: 100%;
      }
      .modal-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      /* Sidebar */
      .editor-sidebar {
        padding: 32px 28px;
        background: var(--surface);
        overflow-y: auto;
      }
      .sidebar-section {
        margin-bottom: 32px;
        animation: fadeIn 0.3s ease both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .sidebar-section:nth-child(2) {
        animation-delay: 0.05s;
      }
      .sidebar-section:nth-child(3) {
        animation-delay: 0.1s;
      }
      .sidebar-section:nth-child(4) {
        animation-delay: 0.15s;
      }
      .sidebar-section:nth-child(5) {
        animation-delay: 0.2s;
      }
      .section-heading {
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-3);
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }
      .form-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-2);
      }
      .form-label .req {
        color: var(--danger);
        margin-left: 2px;
      }
      .form-control {
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text);
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px 12px;
        outline: none;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
        appearance: none;
        width: 100%;
      }
      .form-control:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        background: #fff;
      }
      .form-control.error {
        border-color: var(--danger);
      }
      .form-control::placeholder {
        color: var(--text-3);
      }
      textarea.form-control {
        resize: vertical;
        line-height: 1.6;
      }
      select.form-control {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239a9793' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 32px;
        cursor: pointer;
      }

      /* Tags */
      .tags-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 8px 10px;
        min-height: 44px;
        cursor: text;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
      }
      .tags-wrap:focus-within {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.08);
        background: #fff;
      }
      .tags-wrap.error {
        border-color: var(--danger);
      }
      .tag-chip {
        display: flex;
        align-items: center;
        gap: 4px;
        background: var(--accent);
        color: #fff;
        font-size: 12px;
        font-weight: 500;
        padding: 3px 10px;
        border-radius: 20px;
      }
      .tag-chip button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        padding: 0 0 0 2px;
        transition: color 0.1s;
      }
      .tag-chip button:hover {
        color: #fff;
      }
      .tags-input {
        border: none;
        background: transparent;
        outline: none;
        font-family: var(--font-body);
        font-size: 13px;
        color: var(--text);
        min-width: 100px;
        flex: 1;
      }
      .tags-input::placeholder {
        color: var(--text-3);
      }

      /* Readability */
      .readability-bar {
        height: 6px;
        border-radius: 3px;
        background: var(--border);
        overflow: hidden;
        margin-top: 8px;
      }
      .readability-fill {
        height: 100%;
        border-radius: 3px;
        background: linear-gradient(
          90deg,
          var(--danger),
          var(--warn),
          var(--success)
        );
        transition: width 0.4s ease;
        width: 0%;
      }
      .readability-label {
        font-size: 11px;
        color: var(--text-3);
        margin-top: 4px;
      }

      /* Toggles */
      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-top: 1px solid var(--border);
      }
      .toggle-row:first-child {
        border-top: none;
      }
      .toggle-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .toggle-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
      }
      .toggle-desc {
        font-size: 11px;
        color: var(--text-3);
      }
      .toggle-switch {
        position: relative;
        width: 40px;
        height: 22px;
        flex-shrink: 0;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        inset: 0;
        border-radius: 11px;
        background: var(--border2);
        cursor: pointer;
        transition: background 0.2s;
      }
      .toggle-slider::before {
        content: "";
        position: absolute;
        left: 3px;
        top: 3px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        transition: transform 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      .toggle-switch input:checked + .toggle-slider {
        background: var(--accent);
      }
      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(18px);
      }

      .schedule-row {
        display: none;
        margin-top: 12px;
      }
      .schedule-row.show {
        display: flex;
        gap: 10px;
      }

      /* Publish */
      .publish-actions {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
      }
      .publish-btn-main {
        width: 100%;
        font-family: var(--font-body);
        font-size: 14px;
        font-weight: 600;
        background: var(--text);
        color: #fff;
        border: none;
        border-radius: var(--radius);
        padding: 13px;
        cursor: pointer;
        transition:
          background 0.15s,
          transform 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .publish-btn-main:hover {
        background: #333;
      }
      .publish-btn-main:active {
        transform: scale(0.98);
      }
      .publish-btn-main:disabled {
        background: var(--border2);
        color: var(--text-3);
        cursor: not-allowed;
        transform: none;
      }
      .draft-btn {
        width: 100%;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 500;
        background: transparent;
        color: var(--text-2);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 10px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.15s;
      }
      .draft-btn:hover {
        background: var(--surface2);
        color: var(--text);
      }
      .draft-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Validation summary */
      .validation-summary {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--radius);
        padding: 12px 14px;
        margin-bottom: 16px;
        display: none;
      }
      .validation-summary.show {
        display: block;
      }
      .validation-summary p {
        font-size: 12px;
        font-weight: 600;
        color: var(--danger);
        margin-bottom: 6px;
      }
      .validation-summary ul {
        padding-left: 16px;
      }
      .validation-summary li {
        font-size: 12px;
        color: var(--danger);
        margin-bottom: 3px;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%) translateY(80px);
        background: var(--text);
        color: #fff;
        font-size: 13px;
        font-weight: 500;
        padding: 12px 24px;
        border-radius: 24px;
        box-shadow: var(--shadow-md);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 999;
        white-space: nowrap;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }
      .toast.success {
        background: var(--success);
      }
      .toast.error {
        background: var(--danger);
      }

      /* Loading spinner in button */
      .btn-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Success overlay */
      .success-overlay {
        position: fixed;
        inset: 0;
        z-index: 600;
        background: rgba(22, 163, 74, 0.95);
        backdrop-filter: blur(8px);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        animation: fadeIn 0.3s ease;
      }
      .success-overlay.show {
        display: flex;
      }
      .success-overlay svg {
        color: #fff;
      }
      .success-overlay h2 {
        color: #fff;
        font-family: var(--font-serif);
        font-size: 28px;
      }
      .success-overlay p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 15px;
      }

      @media (max-width: 900px) {
        .editor-shell {
          grid-template-columns: 1fr;
        }
        .editor-sidebar {
          border-top: 1px solid var(--border);
        }
        .editor-main {
          padding: 24px 20px 40px;
        }
        .save-mode-badge {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- ── HEADER ── -->
    <header class="editor-header">
      <div class="header-left">
        <a
          href="javascript:history.back()"
          class="back-btn"
          title="Go Back"
          onclick="confirmLeave(event)"
        >
          <svg
            width="15"
            height="15"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path d="M19 12H5M12 19l-7-7 7-7" />
          </svg>
        </a>

        <span class="site-name">Byte &amp; Beyond</span>
        <!-- FIX: Added id="save-status" so JS can actually find it; fixed SVG viewBox -->
        <span class="save-status" id="save-status">Draft</span>
        <span class="save-mode-badge">
          <svg
            width="11"
            height="11"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
          </svg>
          Auto-save on
        </span>
      </div>
      <div class="header-right">
        <button
          class="btn btn-ghost"
          onclick="saveDraft()"
          id="draft-btn-header"
        >
          Save draft
        </button>
        <div class="avatar" id="user-avatar">J</div>
        <button
          class="btn btn-primary"
          id="publish-btn"
          onclick="handlePublish()"
        >
          Publish Story
        </button>
      </div>
    </header>

    <!-- ── SHELL ── -->
    <div class="editor-shell">
      <!-- EDITOR MAIN -->
      <main class="editor-main">
        <!-- Cover Image -->
        <div class="cover-zone" id="cover-zone">
          <!-- FIX: Single click handler on zone, label is pointer-events: none -->
          <input
            type="file"
            id="cover-file"
            accept="image/*"
            onchange="previewCover(this)"
          />
          <div class="cover-label" id="cover-label">
            <div class="cover-icon">
              <svg
                width="22"
                height="22"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                viewBox="0 0 24 24"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
            </div>
            <span>Add cover image</span>
            <small>Recommended: 1600 × 700px · JPG, PNG, WebP</small>
          </div>
          <img id="image-preview" src="" alt="Cover preview" />
          <button class="cover-change-btn" id="cover-change-btn" type="button">
            Change image
          </button>
        </div>

        <!-- Title -->
        <div class="field-wrap">
          <textarea
            id="title"
            class="title-input"
            placeholder="Story title…"
            rows="1"
            maxlength="120"
            oninput="onTitleInput(this)"
            required
          ></textarea>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span class="field-error" id="title-error"
              >Title is required (min 5 characters)</span
            >
            <span class="char-count" id="title-count">0 / 120</span>
          </div>
        </div>

        <!-- Subtitle -->
        <textarea
          id="subtitle"
          class="subtitle-input"
          placeholder="Add a subtitle or hook line…"
          rows="1"
          oninput="autoResize(this)"
        ></textarea>

        <hr class="editor-divider" />

        <!-- Toolbar -->
        <div class="rte-toolbar">
          <div class="tb-group">
            <select
              class="tb-select"
              onchange="applyFormatBlock(this)"
              title="Text style"
            >
              <option value="p">Paragraph</option>
              <option value="h1">Heading 1</option>
              <option value="h2">Heading 2</option>
              <option value="h3">Heading 3</option>
              <option value="pre">Code block</option>
            </select>
          </div>
          <div class="tb-sep"></div>
          <div class="tb-group">
            <button
              class="tb-btn"
              onclick="execCmd('bold')"
              title="Bold"
              data-cmd="bold"
            >
              <b>B</b>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('italic')"
              title="Italic"
              data-cmd="italic"
            >
              <i>I</i>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('underline')"
              title="Underline"
              data-cmd="underline"
            >
              <u>U</u>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('strikeThrough')"
              title="Strikethrough"
              data-cmd="strikeThrough"
            >
              <s>S</s>
            </button>
          </div>
          <div class="tb-sep"></div>
          <div class="tb-group">
            <button
              class="tb-btn"
              onclick="execCmd('insertUnorderedList')"
              title="Bullet list"
              data-cmd="insertUnorderedList"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <circle cx="3" cy="6" r=".5" fill="currentColor" />
                <circle cx="3" cy="12" r=".5" fill="currentColor" />
                <circle cx="3" cy="18" r=".5" fill="currentColor" />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('insertOrderedList')"
              title="Numbered list"
              data-cmd="insertOrderedList"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="10" y1="6" x2="21" y2="6" />
                <line x1="10" y1="12" x2="21" y2="12" />
                <line x1="10" y1="18" x2="21" y2="18" />
                <path d="M4 6h1v4" />
                <path d="M4 10h2" />
                <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1.5" />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('formatBlock', 'blockquote')"
              title="Blockquote"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"
                />
                <path
                  d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c0 2.25.25 4-2.75 4v3c0 1 0 1 1 1z"
                />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('insertHorizontalRule')"
              title="Divider"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="5" y1="12" x2="19" y2="12" />
              </svg>
            </button>
          </div>
          <div class="tb-sep"></div>
          <div class="tb-group">
            <button
              class="tb-btn"
              onclick="execCmd('justifyLeft')"
              title="Align left"
            >
              <svg
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="3" y1="6" x2="21" y2="6" />
                <line x1="3" y1="12" x2="15" y2="12" />
                <line x1="3" y1="18" x2="18" y2="18" />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('justifyCenter')"
              title="Align center"
            >
              <svg
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="3" y1="6" x2="21" y2="6" />
                <line x1="6" y1="12" x2="18" y2="12" />
                <line x1="4" y1="18" x2="20" y2="18" />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="execCmd('justifyRight')"
              title="Align right"
            >
              <svg
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <line x1="3" y1="6" x2="21" y2="6" />
                <line x1="9" y1="12" x2="21" y2="12" />
                <line x1="6" y1="18" x2="21" y2="18" />
              </svg>
            </button>
          </div>
          <div class="tb-sep"></div>
          <div class="tb-group">
            <button
              class="tb-btn"
              onclick="openLinkModal()"
              title="Insert link"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"
                />
                <path
                  d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"
                />
              </svg>
            </button>
            <button
              class="tb-btn"
              onclick="openImageModal()"
              title="Insert image URL"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
            </button>
            <button class="tb-btn" onclick="insertCode()" title="Inline code">
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <polyline points="16 18 22 12 16 6" />
                <polyline points="8 6 2 12 8 18" />
              </svg>
            </button>
          </div>
          <div class="tb-sep"></div>
          <div class="tb-group">
            <button class="tb-btn" onclick="execCmd('undo')" title="Undo">
              <svg
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <polyline points="9 14 4 9 9 4" />
                <path d="M20 20v-7a4 4 0 00-4-4H4" />
              </svg>
            </button>
            <button class="tb-btn" onclick="execCmd('redo')" title="Redo">
              <svg
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <polyline points="15 14 20 9 15 4" />
                <path d="M4 20v-7a4 4 0 014-4h12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- RTE Body -->
        <div
          id="rte-body"
          class="rte-body"
          contenteditable="true"
          data-placeholder="Tell your story… Use the toolbar above or paste content here."
          oninput="onRteInput()"
          onkeyup="updateToolbarState()"
          onmouseup="updateToolbarState()"
        ></div>

        <div class="rte-footer">
          <span id="word-count">0 words</span>
          <span id="read-time">~0 min read</span>
        </div>

        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-num" id="stat-words">0</div>
            <div class="stat-label">Words</div>
          </div>
          <div class="stat-item">
            <div class="stat-num" id="stat-chars">0</div>
            <div class="stat-label">Chars</div>
          </div>
          <div class="stat-item">
            <div class="stat-num" id="stat-read">0</div>
            <div class="stat-label">Min read</div>
          </div>
          <div class="stat-item">
            <div class="stat-num" id="stat-para">0</div>
            <div class="stat-label">Paragraphs</div>
          </div>
        </div>
      </main>

      <!-- SIDEBAR -->
      <aside class="editor-sidebar">
        <!-- Readability -->
        <div class="sidebar-section">
          <div class="section-heading">
            <svg
              width="12"
              height="12"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
            </svg>
            Readability
          </div>
          <div class="readability-bar">
            <div class="readability-fill" id="readability-fill"></div>
          </div>
          <div class="readability-label" id="readability-label">
            Start writing to see score
          </div>
        </div>

        <!-- Publishing Settings -->
        <div class="sidebar-section">
          <div class="section-heading">
            <svg
              width="12"
              height="12"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.07 4.93a10 10 0 010 14.14M4.93 4.93a10 10 0 000 14.14"
              />
            </svg>
            Publishing Settings
          </div>

          <div class="form-group">
            <label class="form-label" for="categoryId"
              >Category <span class="req">*</span></label
            >
            <select id="categoryId" class="form-control" required>
              <option value="">Select category…</option>
            </select>
            <span class="field-error" id="category-error"
              >Please select a category</span
            >
          </div>

          <div class="form-group">
            <label class="form-label">Tags <span class="req">*</span></label>
            <div
              class="tags-wrap"
              id="tags-wrap"
              onclick="document.getElementById('tags-input').focus()"
            >
              <input
                type="text"
                id="tags-input"
                class="tags-input"
                placeholder="Add tags…"
                onkeydown="handleTag(event)"
                oninput="tagInputHint(this)"
              />
            </div>
            <span class="field-error" id="tags-error"
              >Add at least one tag</span
            >
            <small
              style="
                font-size: 11px;
                color: var(--text-3);
                margin-top: 4px;
                display: block;
              "
              >Press Enter or comma to add · Max 5 tags</small
            >
          </div>

          <div class="form-group">
            <label class="form-label" for="excerpt"
              >SEO Description <span class="req">*</span></label
            >
            <textarea
              id="excerpt"
              class="form-control"
              rows="3"
              maxlength="160"
              placeholder="Write a short summary for search engines…"
              oninput="onExcerptInput(this)"
              required
            ></textarea>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span class="field-error" id="excerpt-error"
                >Description required (min 20 characters)</span
              >
              <span class="char-count" id="excerpt-count">0 / 160</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="slug">URL Slug</label>
            <input
              type="text"
              id="slug"
              class="form-control"
              placeholder="auto-generated-from-title"
              oninput="slugify(this)"
            />
            <small
              style="
                font-size: 11px;
                color: var(--text-3);
                margin-top: 4px;
                display: block;
              "
            >
              yourdomain.com/story/<span
                id="slug-preview"
                style="color: var(--accent)"
                >…</span
              >
            </small>
          </div>
        </div>

        <!-- Visibility -->
        <div class="sidebar-section">
          <div class="section-heading">
            <svg
              width="12"
              height="12"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
              <circle cx="12" cy="12" r="3" />
            </svg>
            Visibility &amp; Options
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <span class="toggle-name">Allow comments</span
              ><span class="toggle-desc">Readers can leave comments</span>
            </div>
            <label class="toggle-switch"
              ><input type="checkbox" id="allow-comments" checked /><span
                class="toggle-slider"
              ></span
            ></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <span class="toggle-name">Featured story</span
              ><span class="toggle-desc">Pin to top of feed</span>
            </div>
            <label class="toggle-switch"
              ><input type="checkbox" id="featured" /><span
                class="toggle-slider"
              ></span
            ></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <span class="toggle-name">Members only</span
              ><span class="toggle-desc">Restrict to subscribers</span>
            </div>
            <label class="toggle-switch"
              ><input type="checkbox" id="members-only" /><span
                class="toggle-slider"
              ></span
            ></label>
          </div>
          <div class="toggle-row">
            <div class="toggle-info">
              <span class="toggle-name">Schedule publish</span
              ><span class="toggle-desc">Set a future publish date</span>
            </div>
            <label class="toggle-switch"
              ><input
                type="checkbox"
                id="schedule-toggle"
                onchange="toggleSchedule(this)" /><span
                class="toggle-slider"
              ></span
            ></label>
          </div>
          <div class="schedule-row" id="schedule-row">
            <input
              type="date"
              class="form-control"
              id="schedule-date"
              style="flex: 1"
            />
            <input
              type="time"
              class="form-control"
              id="schedule-time"
              style="width: 110px"
            />
          </div>
        </div>

        <!-- Publish -->
        <div class="sidebar-section">
          <div class="validation-summary" id="validation-summary">
            <p>Please fix the following:</p>
            <ul id="validation-list"></ul>
          </div>
          <div class="publish-actions">
            <button
              class="publish-btn-main"
              id="sidebar-publish-btn"
              onclick="handlePublish()"
            >
              <svg
                width="15"
                height="15"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path d="M22 2L11 13" />
                <path d="M22 2L15 22 11 13 2 9l20-7z" />
              </svg>
              Publish Story
            </button>
            <button
              class="draft-btn"
              id="sidebar-draft-btn"
              onclick="saveDraft()"
            >
              Save as draft
            </button>
          </div>
        </div>
      </aside>
    </div>

    <!-- IMAGE MODAL -->
    <div class="modal-overlay" id="image-modal">
      <div class="modal-box">
        <div class="modal-title">
          <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <circle cx="8.5" cy="8.5" r="1.5" />
            <polyline points="21 15 16 10 5 21" />
          </svg>
          Insert Image
        </div>
        <div class="modal-field">
          <label class="modal-label">Image URL</label>
          <input
            type="url"
            id="img-url-input"
            class="modal-input"
            placeholder="https://example.com/image.jpg"
          />
        </div>
        <div class="modal-field">
          <label class="modal-label">Alt text</label>
          <input
            type="text"
            id="img-alt-input"
            class="modal-input"
            placeholder="Describe the image…"
          />
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('image-modal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="insertImage()">
            Insert
          </button>
        </div>
      </div>
    </div>

    <!-- LINK MODAL -->
    <div class="modal-overlay" id="link-modal">
      <div class="modal-box">
        <div class="modal-title">
          <svg
            width="18"
            height="18"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"
            />
            <path
              d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"
            />
          </svg>
          Insert Link
        </div>
        <div class="modal-field">
          <label class="modal-label">URL</label>
          <input
            type="url"
            id="link-url-input"
            class="modal-input"
            placeholder="https://example.com"
          />
        </div>
        <div class="modal-field">
          <label class="modal-label">Display text (optional)</label>
          <input
            type="text"
            id="link-text-input"
            class="modal-input"
            placeholder="Leave empty to use selection"
          />
        </div>
        <div class="modal-actions">
          <button class="btn btn-ghost" onclick="closeModal('link-modal')">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="insertLink()">Insert</button>
        </div>
      </div>
    </div>

    <!-- SUCCESS OVERLAY -->
    <div class="success-overlay" id="success-overlay">
      <svg
        width="64"
        height="64"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <circle cx="12" cy="12" r="10" />
        <polyline points="9 12 11 14 15 10" />
      </svg>
      <h2>Story Published!</h2>
      <p id="success-message">Your story is now live.</p>
    </div>

    <!-- TOAST -->
    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <input type="hidden" id="post-id" value="<%= postId %>" />

    <script src="/js/auth.js"></script>

    <script>
      // Auth check
      if (!isAuthenticated()) {
        window.location.href =
          "/login?redirect=" + encodeURIComponent(window.location.pathname);
      }

      /* ═══════════════════════════════════════════
         STATE
      ═══════════════════════════════════════════ */
      let tags = [];
      let savedSelection = null;
      let autosaveTimer = null;
      let isDirty = false;

      /* ═══════════════════════════════════════════
         INIT
      ═══════════════════════════════════════════ */
      document.addEventListener("DOMContentLoaded", () => {
        // Auth check
        if (!isAuthenticated()) {
          window.location.href = `/login?redirect=${encodeURIComponent(window.location.pathname)}`;
          return;
        }

        // Initialize App
        init();

        // Cover zone click — single handler
        const zone = document.getElementById("cover-zone");
        if (zone) {
          zone.addEventListener("click", () => {
            document.getElementById("cover-file").click();
          });
        }

        // "Change image" button should still work but not bubble twice
        const changeBtn = document.getElementById("cover-change-btn");
        if (changeBtn) {
          changeBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            document.getElementById("cover-file").click();
          });
        }

        // Auto-resize all textareas on load
        document.querySelectorAll("textarea").forEach((el) => autoResize(el));

        // Set schedule date default
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const schedDate = document.getElementById("schedule-date");
        const schedTime = document.getElementById("schedule-time");
        if (schedDate) schedDate.value = tomorrow.toISOString().split("T")[0];
        if (schedTime) schedTime.value = "09:00";

        // Dirty tracking for leave confirmation
        const titleInput = document.getElementById("title");
        const rteBody = document.getElementById("rte-body");
        if (titleInput)
          titleInput.addEventListener("input", () => {
            isDirty = true;
          });
        if (rteBody)
          rteBody.addEventListener("input", () => {
            isDirty = true;
          });
      });

      /* ═══════════════════════════════════════════
         DATA LOADING
      ═══════════════════════════════════════════ */
      async function loadCategories() {
        const select = document.getElementById("categoryId");
        try {
          const data = await apiRequest("/categories");
          if (data.success) {
            // Keep the default "Select category..." option
            let options = '<option value="">Select category…</option>';
            data.categories.forEach((cat) => {
              options += `<option value="${cat._id}">${cat.name}</option>`;
            });
            select.innerHTML = options;
          }
        } catch (err) {
          console.error("Failed to load categories:", err);
          showToast("Failed to load categories", "error");
        }
      }

      /* ═══════════════════════════════════════════
         PUBLISH
      ═══════════════════════════════════════════ */
      /* ═══════════════════════════════════════════
         PUBLISH / UPDATE (Public)
      ═══════════════════════════════════════════ */
      async function handlePublish() {
        if (!validateAll()) {
          showToast("Please fix the errors before publishing", "error");
          return;
        }

        setPublishingState(true);
        setSaveStatus("Publishing…", "saving");

        try {
          const postId = document.getElementById("post-id").value;
          // Collect data with 'published' status
          const formData = collectFormData("published");

          // Use PUT to update existing post
          const data = await apiRequest(`/posts/${postId}`, {
            method: "PUT",
            body: formData,
          });

          setSaveStatus("Published", "saved");
          isDirty = false;

          // Show success overlay
          document.getElementById("success-overlay").classList.add("show");
          document.querySelector("#success-overlay h2").textContent =
            "Story Updated!";
          document.querySelector("#success-overlay p").textContent =
            "Your changes have been live.";

          // Redirect to view page
          setTimeout(() => {
            window.location.href = `/posts/${postId}`;
          }, 1500);
        } catch (err) {
          console.error("Publish error:", err);
          showToast(err.message || "Error updating story", "error");
          setSaveStatus("Error", "saving");
          setPublishingState(false);
        }
      }
      /* ═══════════════════════════════════════════
         UTILITIES
      ═══════════════════════════════════════════ */
      function showToast(msg, type = "") {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.className = "toast show " + type;
        setTimeout(() => {
          t.className = "toast";
        }, 3000);
      }

      // FIX: setSaveStatus now correctly targets the #save-status element that exists in the DOM
      function setSaveStatus(txt, cls = "") {
        const s = document.getElementById("save-status");
        if (!s) return;
        s.textContent = txt;
        s.className = "save-status " + cls;
      }

      function autoResize(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      }

      function confirmLeave(e) {
        if (isDirty) {
          e.preventDefault();
          if (confirm("You have unsaved changes. Leave without saving?")) {
            window.history.back();
          }
        }
      }

      /* ═══════════════════════════════════════════
         COVER IMAGE
      ═══════════════════════════════════════════ */
      function previewCover(input) {
        if (!input.files || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.getElementById("image-preview");
          const zone = document.getElementById("cover-zone");
          preview.src = e.target.result;
          preview.style.display = "block";
          zone.classList.add("has-image");
        };
        reader.readAsDataURL(input.files[0]);
      }

      /* ═══════════════════════════════════════════
         TITLE
      ═══════════════════════════════════════════ */
      function onTitleInput(el) {
        autoResize(el);
        const len = el.value.length;
        const counter = document.getElementById("title-count");
        counter.textContent = len + " / 120";
        counter.className =
          "char-count" + (len > 115 ? " over" : len > 100 ? " warn" : "");
        // Auto-generate slug
        const slug = el.value
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, "")
          .trim()
          .replace(/\s+/g, "-");
        document.getElementById("slug").value = slug;
        document.getElementById("slug-preview").textContent = slug || "…";
        isDirty = true;
        triggerAutosave();
      }

      /* ═══════════════════════════════════════════
         SLUG
      ═══════════════════════════════════════════ */
      function slugify(el) {
        const clean = el.value
          .toLowerCase()
          .replace(/[^a-z0-9-]/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");
        el.value = clean;
        document.getElementById("slug-preview").textContent = clean || "…";
      }

      /* ═══════════════════════════════════════════
         EXCERPT
      ═══════════════════════════════════════════ */
      function onExcerptInput(el) {
        const len = el.value.length;
        const counter = document.getElementById("excerpt-count");
        counter.textContent = len + " / 160";
        counter.className =
          "char-count" + (len > 155 ? " over" : len > 140 ? " warn" : "");
        triggerAutosave();
      }

      /* ═══════════════════════════════════════════
         RTE
      ═══════════════════════════════════════════ */
      function execCmd(cmd, val = null) {
        document.getElementById("rte-body").focus();
        document.execCommand(cmd, false, val);
        updateToolbarState();
        onRteInput();
      }

      // FIX: formatBlock select — reset select value after applying
      function applyFormatBlock(select) {
        const val = select.value;
        if (!val) return;
        document.getElementById("rte-body").focus();
        document.execCommand("formatBlock", false, val);
        setTimeout(() => {
          select.value = "p";
        }, 0);
        onRteInput();
      }

      function insertCode() {
        const sel = window.getSelection();
        const text = sel && sel.toString() ? sel.toString() : "code";
        document.getElementById("rte-body").focus();
        document.execCommand("insertHTML", false, `<code>${text}</code>`);
        onRteInput();
      }

      function updateToolbarState() {
        [
          "bold",
          "italic",
          "underline",
          "strikeThrough",
          "insertUnorderedList",
          "insertOrderedList",
        ].forEach((cmd) => {
          const btn = document.querySelector(`[data-cmd="${cmd}"]`);
          if (btn)
            btn.classList.toggle("active", document.queryCommandState(cmd));
        });
      }

      function onRteInput() {
        const el = document.getElementById("rte-body");
        const text = el.innerText || "";
        const words = text.trim().split(/\s+/).filter(Boolean);
        const wc = words.length;
        const cc = text.replace(/\s/g, "").length;
        const readMin = Math.max(1, Math.round(wc / 200));
        const paraCount = el.querySelectorAll(
          "p,h1,h2,h3,blockquote,li",
        ).length;

        document.getElementById("word-count").textContent = wc + " words";
        document.getElementById("read-time").textContent =
          "~" + readMin + " min read";
        document.getElementById("stat-words").textContent = wc;
        document.getElementById("stat-chars").textContent = cc;
        document.getElementById("stat-read").textContent = readMin;
        document.getElementById("stat-para").textContent = paraCount;

        // Simple readability score
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 0).length;
        const avgWords = sentences > 0 ? wc / sentences : wc;
        const score = Math.min(
          100,
          Math.max(0, Math.round(100 - (avgWords - 10) * 3)),
        );
        document.getElementById("readability-fill").style.width = score + "%";
        document.getElementById("readability-label").textContent =
          wc < 10
            ? "Start writing to see score"
            : score < 30
              ? "Needs work — try shorter sentences"
              : score < 60
                ? "Fair"
                : score < 80
                  ? "Good"
                  : "Excellent";

        isDirty = true;
        triggerAutosave();
      }

      /* ═══════════════════════════════════════════
         TAGS
      ═══════════════════════════════════════════ */
      function handleTag(e) {
        const input = document.getElementById("tags-input");
        if (e.key === "Enter" || e.key === ",") {
          e.preventDefault();
          addTag(input.value.trim().replace(",", ""));
          input.value = "";
        } else if (e.key === "Backspace" && input.value === "" && tags.length) {
          removeTag(tags.length - 1);
        }
      }

      function addTag(val) {
        val = val.toLowerCase().trim();
        if (!val || tags.includes(val) || tags.length >= 5) return;
        tags.push(val);
        renderTags();
      }

      function removeTag(idx) {
        tags.splice(idx, 1);
        renderTags();
      }

      function renderTags() {
        const wrap = document.getElementById("tags-wrap");
        const input = document.getElementById("tags-input");
        wrap.querySelectorAll(".tag-chip").forEach((el) => el.remove());
        tags.forEach((t, i) => {
          const chip = document.createElement("div");
          chip.className = "tag-chip";
          chip.innerHTML = `${t}<button onclick="removeTag(${i})" type="button" title="Remove tag">×</button>`;
          wrap.insertBefore(chip, input);
        });
        // Update placeholder
        input.placeholder =
          tags.length >= 5
            ? "Max tags reached"
            : tags.length === 0
              ? "Add tags…"
              : "Add more…";
      }

      function tagInputHint(el) {
        if (el.value.includes(",")) {
          addTag(el.value.replace(",", "").trim());
          el.value = "";
        }
      }

      /* ═══════════════════════════════════════════
         SCHEDULE
      ═══════════════════════════════════════════ */
      function toggleSchedule(el) {
        document
          .getElementById("schedule-row")
          .classList.toggle("show", el.checked);
      }

      /* ═══════════════════════════════════════════
         MODALS
      ═══════════════════════════════════════════ */
      function openImageModal() {
        saveSelection();
        document.getElementById("image-modal").classList.add("open");
        setTimeout(() => document.getElementById("img-url-input").focus(), 100);
      }

      function openLinkModal() {
        saveSelection();
        const sel = window.getSelection();
        if (sel)
          document.getElementById("link-text-input").value = sel.toString();
        document.getElementById("link-modal").classList.add("open");
        setTimeout(
          () => document.getElementById("link-url-input").focus(),
          100,
        );
      }

      function closeModal(id) {
        document.getElementById(id).classList.remove("open");
      }

      function saveSelection() {
        const sel = window.getSelection();
        if (sel && sel.rangeCount > 0)
          savedSelection = sel.getRangeAt(0).cloneRange();
      }

      function restoreSelection() {
        if (!savedSelection) return;
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
      }

      function insertImage() {
        const url = document.getElementById("img-url-input").value.trim();
        const alt = document.getElementById("img-alt-input").value.trim();
        if (!url) {
          showToast("Please enter an image URL", "error");
          return;
        }
        restoreSelection();
        document.getElementById("rte-body").focus();
        document.execCommand(
          "insertHTML",
          false,
          `<img src="${url}" alt="${alt || "Image"}" style="max-width:100%;border-radius:8px;margin:8px 0;">`,
        );
        closeModal("image-modal");
        document.getElementById("img-url-input").value = "";
        document.getElementById("img-alt-input").value = "";
        onRteInput();
      }

      function insertLink() {
        const url = document.getElementById("link-url-input").value.trim();
        const txt = document.getElementById("link-text-input").value.trim();
        if (!url) {
          showToast("Please enter a URL", "error");
          return;
        }
        restoreSelection();
        document.getElementById("rte-body").focus();
        if (txt) {
          document.execCommand(
            "insertHTML",
            false,
            `<a href="${url}" target="_blank" rel="noopener">${txt}</a>`,
          );
        } else {
          document.execCommand("createLink", false, url);
          document
            .getElementById("rte-body")
            .querySelectorAll("a:not([target])")
            .forEach((a) => {
              a.setAttribute("target", "_blank");
              a.setAttribute("rel", "noopener");
            });
        }
        closeModal("link-modal");
        document.getElementById("link-url-input").value = "";
        document.getElementById("link-text-input").value = "";
        onRteInput();
      }

      // Close on overlay click or Escape
      document.querySelectorAll(".modal-overlay").forEach((overlay) => {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) overlay.classList.remove("open");
        });
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape")
          document
            .querySelectorAll(".modal-overlay.open")
            .forEach((m) => m.classList.remove("open"));
        // Ctrl/Cmd+S = save draft
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          saveDraft();
        }
      });

      /* ═══════════════════════════════════════════
         VALIDATION
      ═══════════════════════════════════════════ */
      function validateField(el, errorId, msg) {
        const err = document.getElementById(errorId);
        const invalid = !el.value.trim();
        el.classList.toggle("error", invalid);
        if (err) err.classList.toggle("show", invalid);
        return !invalid;
      }

      function validateAll() {
        const errors = [];

        const title = document.getElementById("title").value.trim();
        const titleValid = title.length >= 5;
        document.getElementById("title").classList.toggle("error", !titleValid);
        document
          .getElementById("title-error")
          .classList.toggle("show", !titleValid);
        if (!titleValid)
          errors.push("Story title is required (min 5 characters)");

        const content = document.getElementById("rte-body").innerText.trim();
        const contentValid = content.length >= 50;
        document
          .getElementById("rte-body")
          .classList.toggle("error", !contentValid);
        if (!contentValid)
          errors.push("Story content is required (min 50 characters)");

        const cat = document.getElementById("categoryId").value;
        const catValid = !!cat;
        document
          .getElementById("categoryId")
          .classList.toggle("error", !catValid);
        document
          .getElementById("category-error")
          .classList.toggle("show", !catValid);
        if (!catValid) errors.push("Please select a category");

        const tagsValid = tags.length > 0;
        document
          .getElementById("tags-wrap")
          .classList.toggle("error", !tagsValid);
        document
          .getElementById("tags-error")
          .classList.toggle("show", !tagsValid);
        if (!tagsValid) errors.push("Add at least one tag");

        const excerpt = document.getElementById("excerpt").value.trim();
        const excerptValid = excerpt.length >= 20;
        document
          .getElementById("excerpt")
          .classList.toggle("error", !excerptValid);
        document
          .getElementById("excerpt-error")
          .classList.toggle("show", !excerptValid);
        if (!excerptValid)
          errors.push("SEO description required (min 20 characters)");

        const summary = document.getElementById("validation-summary");
        const list = document.getElementById("validation-list");
        if (errors.length) {
          list.innerHTML = errors.map((e) => `<li>${e}</li>`).join("");
          summary.classList.add("show");
          summary.scrollIntoView({ behavior: "smooth", block: "nearest" });
        } else {
          summary.classList.remove("show");
        }
        return errors.length === 0;
      }

      /* ═══════════════════════════════════════════
         BUTTON STATE HELPERS
      ═══════════════════════════════════════════ */
      function setPublishingState(loading) {
        const pubBtn = document.getElementById("publish-btn");
        const sidebarBtn = document.getElementById("sidebar-publish-btn");
        const draftBtnH = document.getElementById("draft-btn-header");
        const draftBtnS = document.getElementById("sidebar-draft-btn");

        [pubBtn, sidebarBtn, draftBtnH, draftBtnS].forEach((b) => {
          if (b) b.disabled = loading;
        });

        if (loading) {
          sidebarBtn.innerHTML = `<span class="btn-spinner"></span> Publishing…`;
        } else {
          sidebarBtn.innerHTML = `<svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg> Publish Story`;
        }
      }

      /* ═══════════════════════════════════════════
         COLLECT FORM DATA
      ═══════════════════════════════════════════ */
      function collectFormData(status = "published") {
        const formData = new FormData();
        formData.append(
          "title",
          document.getElementById("title").value.trim() || "Untitled Draft",
        );
        formData.append(
          "content",
          document.getElementById("rte-body").innerHTML,
        );
        formData.append(
          "excerpt",
          document.getElementById("excerpt").value.trim(),
        );
        formData.append("slug", document.getElementById("slug").value.trim());
        // Determine visibility
        const isMembersOnly = document.getElementById("members-only").checked;
        let visibility = "draft";

        if (status === "published" || status === "public") {
          // Handle both terminologies if any
          visibility = isMembersOnly ? "private" : "public";
        } else {
          visibility = "draft";
        }

        formData.append("visibility", visibility);
        // We can still send status for backward compatibility if needed, but visibility is the source of truth now
        formData.append("status", status); // Keep for now

        /* Removed deprecated membersOnly field
        formData.append(
          "membersOnly",
          document.getElementById("members-only").checked,
        );
        */

        // Append Tags
        if (typeof tags !== "undefined" && Array.isArray(tags)) {
          tags.forEach((tag) => formData.append("tags", tag));
        }

        const fileInput = document.getElementById("cover-file");
        if (fileInput.files[0]) formData.append("image", fileInput.files[0]);

        // Schedule
        const scheduled = document.getElementById("schedule-toggle").checked;
        if (scheduled) {
          const d = document.getElementById("schedule-date").value;
          const t = document.getElementById("schedule-time").value;
          if (d && t)
            formData.append("scheduledAt", new Date(d + "T" + t).toISOString());
        }

        return formData;
      }

      /* ═══════════════════════════════════════════
          INIT & LOAD DATA
       ═══════════════════════════════════════════ */
      async function init() {
        // Load categories First
        await loadCategories();

        // Then load post data
        await loadPostData();
      }

      async function loadPostData() {
        const postId = document.getElementById("post-id").value;
        if (!postId) return;

        try {
          setSaveStatus("Loading...", "saving");
          const res = await apiRequest(`/posts/${postId}`);
          if (!res.success)
            throw new Error(res.message || "Failed to load post");

          const post = res.post;

          // Populate Fields
          document.getElementById("title").value = post.title || "";
          onTitleInput(document.getElementById("title"));

          if (post.slug) {
            document.getElementById("slug").value = post.slug;
            document.getElementById("slug-preview").textContent = post.slug;
          }

          document.getElementById("rte-body").innerHTML = post.content || "";
          updateToolbarState();
          onRteInput();

          if (post.excerpt) {
            document.getElementById("excerpt").value = post.excerpt;
            onExcerptInput(document.getElementById("excerpt"));
          }

          if (post.categoryId) {
            const catId =
              typeof post.categoryId === "object"
                ? post.categoryId._id
                : post.categoryId;
            document.getElementById("categoryId").value = catId;
          }

          if (post.image) {
            const zone = document.getElementById("cover-zone");
            const preview = document.getElementById("image-preview");
            preview.src = post.image;
            preview.style.display = "block";
            zone.classList.add("has-image");
          }

          if (post.tags && Array.isArray(post.tags)) {
            post.tags.forEach((tag) => addTag(tag));
          }

          document.getElementById("featured").checked = !!post.featured;
          document.getElementById("allow-comments").checked =
            post.allowComments !== false;
          document.getElementById("members-only").checked =
            post.visibility === "private";

          if (post.scheduledAt) {
            const d = new Date(post.scheduledAt);
            document.getElementById("schedule-toggle").checked = true;
            document.getElementById("schedule-row").classList.add("show");
            document.getElementById("schedule-date").value = d
              .toISOString()
              .split("T")[0];
            const hours = String(d.getHours()).padStart(2, "0");
            const minutes = String(d.getMinutes()).padStart(2, "0");
            document.getElementById("schedule-time").value =
              `${hours}:${minutes}`;
          }

          // Update Button Label
          const publishBtn = document.getElementById("sidebar-publish-btn");
          if (post.visibility === "public" || post.visibility === "private") {
            publishBtn.innerHTML = `<svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg> Update Story`;
            setSaveStatus(
              post.visibility === "private" ? "Members Only" : "Published",
              "saved",
            );
          }

          isDirty = false;
        } catch (err) {
          console.error("Load post error:", err);
          showToast("Failed to load post data: " + err.message, "error");
        }
      }

      async function saveDraft() {
        const postId = document.getElementById("post-id").value;
        setSaveStatus("Saving...", "saving");

        try {
          const formData = collectFormData("draft");
          const data = await apiRequest(`/posts/${postId}`, {
            method: "PUT",
            body: formData,
          });

          setSaveStatus("Saved", "saved");
          isDirty = false;
          showToast("Draft saved successfully", "success");
        } catch (err) {
          console.error("Save draft error:", err);
          showToast("Failed to save draft: " + err.message, "error");
          setSaveStatus("Error", "error");
        }
      }

      function triggerAutosave() {
        if (!isDirty) return;
        setSaveStatus("Saving...", "saving");
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(() => {
          setSaveStatus("Saved", "saved");
        }, 1500);
      }

      // Avatar & User Info
      const setupUser = () => {
        const user = getUser();
        if (user) {
          const avatarEl = document.getElementById("user-avatar");
          if (avatarEl) {
            if (user.avatar) {
              avatarEl.style.backgroundImage = `url(${user.avatar})`;
              avatarEl.style.backgroundSize = "cover";
              avatarEl.textContent = "";
            } else {
              avatarEl.textContent = (user.displayName || user.username || "U")
                .substring(0, 2)
                .toUpperCase();
            }
          }
        }
      };
      setupUser();
    </script>
  </body>
</html>
